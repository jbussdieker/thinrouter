#!/usr/bin/env ruby
$: << File.expand_path("./../../lib", __FILE__)
require 'thinrouter/dhcp'
require 'sinatra'
require 'yaml'

DHCP = Thinrouter::Dhcp

set :views, settings.root + '/../templates'
set :public_folder, settings.root + '/../public'

def commit_dhcp
  puts `sudo ./update_dhcp`
  result = ($?.to_i == 0)
end

get '/' do
  erb :'home/index.html', :'layout/application.html'
end

get '/dns' do
  erb :'dns/index.html', :layout => :'layout/application.html'
end

post '/dhcp' do
  res = DHCP.create({
    :host => params[:host],
    :mac => params[:mac],
    :ip => params[:ip],
  })
  result = commit_dhcp
  redirect "/dhcp?result=#{result}"
end

get '/dhcp/:id/edit' do
  res = DHCP.find(params[:id])
  erb :'dhcp/edit.html', :layout => :'layout/application.html', :locals => { :res => res }
end

post '/dhcp/:id/edit' do
  res = DHCP.find(params[:id])
  res.ip = params[:ip]
  res.mac = params[:mac]
  res.host = params[:new_host]
  res.save
  result = commit_dhcp
  redirect "/dhcp?result=#{result}"
end

delete '/dhcp/:id' do
  res = DHCP.find(params[:id])
  res.delete
  result = commit_dhcp
  redirect "/dhcp?result=#{result}"
end

get '/dhcp' do
  erb :'dhcp/index.html', :layout => :'layout/application.html'
end

get '/dhcp/new' do
  erb :'dhcp/new.html', :layout => :'layout/application.html'
end

get '/dhcp/leases' do
  erb :'dhcp/leases.html', :layout => :'layout/application.html'
end
